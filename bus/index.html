<head>
	<title>Bus Arrival Times</title>

	<meta charset="utf-8"> <!--ensures that there aren't any issues with the display of emojis -->
	<meta name="viewport" content="width=device-width"> <!-- essential for making sure that the ACTUAL screen width is interpreted by the CSS as opposed to some idealized number presented by smartphones (980px+) -->
	<meta name="robots" content="noindex, nofollow"> <!-- excludes page from web browser search results -->

	<link rel="stylesheet" href="../style.css">
	<link rel="shortcut icon" href="../favicon.ico">

	<!-- Google font stuff -->
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Freeman&display=block" rel="stylesheet">

	<!-- icon library -->
	<script src="https://kit.fontawesome.com/157b2a3980.js" crossorigin="anonymous"></script>
	
</head>

<style>

	html, body {
		height: 100%;
		margin: 0;
	}

	body {
		display: flex;
		justify-content: center;
		align-items: center;
	}

	.direction-information {
		font-size: 40%;
	}

	.countdown-time {
		width: 10vw;
	}

	.walk-time {
		font-size: 30%;
	}

	.mirrored {
		transform: scaleX(-1);
	}

	.bus-number {
			background-color: black; 
			color: var(--color3); 
			border-radius: 6vw; 
			padding-left: 3vw; 
			padding-right: 3vw;
	}

	@media (prefers-color-scheme: dark) {
		html {
			background-color: black;
			color: var(--color3);
		}

		.bus-number {
			background-color: var(--color1);
		}
	}

</style>

<body>
	<div> <!-- this div makes sure that the body's flexbox layout doesn't rearrange overall webpage content -->
		<table style="margin: 0 auto 4vw auto; width: 90%; font-family: freeman; font-size: 6vw; text-align: center; border-collapse: separate; border-spacing: 2vw">
			<tr>
				<td  colspan="2" class="direction-information">
					<i class="fa-solid fa-arrow-left"></i> ðŸŸ  east
				</td>
				<td>
					<i class="fa-solid fa-person-walking mirrored"></i>
					<br>
					<span class="walk-time"><span id="walk-time-east"></span> min </span>
						</td>
				<td></td>
				<td>
					<i class="fa-solid fa-person-walking"></i>
					<br>
					<span class="walk-time"><span id="walk-time-west"></span> min </span>
				</td>
				<td colspan="2" class="direction-information">
					west ðŸŸ¢ðŸ”´ <i class="fa-solid fa-arrow-right"></i>
				</td>
			</tr>
			<tr>
				<td class="countdown-time" id="109-E3"></td>
				<td class="countdown-time" id="109-E2"></td>
				<td class="countdown-time" id="109-E1"></td>
				<td><div class="bus-number">109</div></td>
				<td class="countdown-time" id="109-W1"></td>
				<td class="countdown-time" id="109-W2"></td>
				<td class="countdown-time" id="109-W3"></td>
			</tr>
			<tr>
				<td class="countdown-time" id="91-E3"></td>
				<td class="countdown-time" id="91-E2"></td>
				<td class="countdown-time" id="91-E1"></td>
				<td><div class="bus-number">91</div></td>
				<td class="countdown-time" id="91-W1"></td>
				<td class="countdown-time" id="91-W2"></td>
				<td class="countdown-time" id="91-W3"></td>
			</tr>
			<tr>
				<td class="countdown-time" id="CT2-E3"></td>
				<td class="countdown-time" id="CT2-E2"></td>
				<td class="countdown-time" id="CT2-E1"></td>
				<td><div class="bus-number">CT2</div></td>
				<td class="countdown-time" id="CT2-W1"></td>
				<td class="countdown-time" id="CT2-W2"></td>
				<td class="countdown-time" id="CT2-W3"></td>
			</tr>
		</table>
		<div class="content">
			<p>Times shown in the table above represent the minutes remaining to step out the door in order to make each bus, which take into account the walking distance to each bus stop plus one extra minute for comfort. </p>

			<p>MBTA bus arrival predictions last refreshed <span id="counter">0 seconds</span> ago.</p>
		</div>
	</div>
</body>

<script type="text/javascript">
	const urlWest = "https://api-v3.mbta.com/predictions?filter[stop]=12759"
	const urlEast = "https://api-v3.mbta.com/predictions?filter[stop]=2778"
	const walkTimeWest = 3
	const walkTimeEast = 4
	const gracePeriod = 1
	let timeTable = {};

	// display walk times
	document.getElementById("walk-time-west").innerHTML = walkTimeWest;
	document.getElementById("walk-time-east").innerHTML = walkTimeEast;

	function fetchTimes(url, direction, walkTime) {
		fetch(url)
			.then(response => response.json())
			.then(data => {
				data.data.forEach(prediction => {
					const depTime = new Date(prediction.attributes.departure_time); // extract the arrival time string from the API and turn it into a number via the built-in Date() function
					const now = new Date();
					let waitTime = Math.round(((depTime - now) / 1000 / 60) - walkTime - gracePeriod); // convert from miliseconds to minutes and round to the nearest whole number
					if (waitTime === -0) {
						waitTime = 0;
					};

					let route = prediction.relationships.route.data.id;

					if (route === "747") {
						route = "CT2";
					};

					if(!timeTable[route]) {
						timeTable[route] = {};
					};

					if (!("counter" in timeTable[route])) {
						timeTable[route]["counter"] = 1;
					};

					if (waitTime >= 0) {

						if (timeTable[route]["counter"] <= 3) {
							timeTable[route][route + "-" + direction + timeTable[route]["counter"]] = waitTime;
						};
						
						timeTable[route]["counter"] += 1;

					};
				});
			})
			.then( () => {
				for (const route in timeTable) {
					delete timeTable[route]["counter"]; // clear the counter keys so they can restart for the other direction
				};
			})
			.then(updateTable);
	};

	function updateTable() {
		for (const route in timeTable) {
			for (const prediction in timeTable[route]) {
				document.getElementById(prediction).innerHTML = timeTable[route][prediction];
			};
		};
	};

	function refreshTimes() {
		fetchTimes(urlWest, "W", walkTimeWest);
		fetchTimes(urlEast, "E", walkTimeEast);
		lastRefresh = new Date();
	}

	setInterval(refreshTimes, 15000);
	let lastRefresh = new Date();
	refreshTimes();

	// update refresh timer //
	setInterval(() => {
	    const now = new Date();
	    const diffSec = Math.floor((now - lastRefresh) / 1000);
	    if (diffSec === 1) {
	    	document.getElementById("counter").innerHTML = "1 second";
	    } else {
    		document.getElementById("counter").innerHTML = diffSec + " seconds";
	    }
	}, 100);
</script>